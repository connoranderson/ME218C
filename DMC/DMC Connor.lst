MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001         errorlevel -302
                      00002         errorlevel -305
                      00003         list    p=PIC12F752
                      00004 #include "p12F752.inc"
                      00001         LIST
                      00002 
                      00003 ;==========================================================================
                      00004 ;  MPASM PIC12F752 processor include
                      00005 ; 
                      00006 ;  (c) Copyright 1999-2010 Microchip Technology, All rights reserved
                      00007 ;==========================================================================
                      00008 
                      00647         LIST
                      00005 
                      00006 ;
                      00007 ;               Code Protection OFF     (_CP_OFF)
                      00008 ;               Watchdog Timer OFF      (_WDTE_OFF)
                      00009 ;               Power Up Timer Enable ON        (_PWRTE_ON) WAITS TO RUN YOUR CODE TILL TIMER IS STABLE
                      00010 ;               MCLR Control OFF        (_MCLRE_OFF)
                      00011 ;               Oscillator Type INT     (_FOSC0_INT)
                      00012 ;               Write Project OFF       (_WRT_OFF)
2007   3FE6           00013                 __config(_CP_OFF & _WDT_OFF & _PWRTE_ON & _FOSC_INT)
                      00014         ;__config (_CP_OFF & _WDTE_OFF & _PWRTE_ON & _MCLRE_OFF & _FOSC0_INT & _WRT_OFF)
                      00015        
                      00016 ;       
                      00017 ;               variable definitions
                      00018 ;
                      00019         
                      00020 ;Binary conventions
  00000000            00021 WAITING                                         equ             0
  00000001            00022 RECEIVING                                       equ             1
  00000001            00023 STEP                                            equ             1
  00000000            00024 OFF                                                     equ             0
  00000001            00025 ON                                                      equ             1
                      00026 
                      00027 ;Pins
  00000000            00028 LINE_IN                                         equ             RA0
  00000001            00029 RED_LED                                         equ             LATA1
  00000002            00030 BLUE_LED                                        equ             LATA2
  00000004            00031 STEPPER_DIR                                     equ             LATA4
  00000005            00032 STEPPER_EN                                      equ             LATA5
                      00033 
                      00034 ;Variables
  00000070            00035 PACKET                                          equ             0x70
  00000071            00036 MOTOR_STATE                                     equ             0x71
  00000072            00037 LED_STATE                                       equ             0x72
  00000073            00038 BITS_LEFT                                       equ             0x73
  00000074            00039 COUNTS_LEFT                                     equ             0x74
                      00040 
  00000075            00041 WREG_TEMP                                       equ     0x75
  00000076            00042 STATUS_TEMP                             equ     0x76
  00000077            00043 PCLATH_TEMP                             equ     0x77
                      00044 
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000078            00045 PACKET_COPY                                     equ             0x78
  00000079            00046 IS_PAIRED                                       equ             0x79
  0000007A            00047 COLOR                                           equ             0x7A
  0000007B            00048 LED_ON                                          equ             0x7B
  0000007C            00049 LED_Timeval                                     equ             0x7C
  0000007D            00050 LED_Counter                                     equ             0x7D
  0000007E            00051 LED_Lowerval                            equ             0x7E
  0000007F            00052 LED_Upperval                            equ             0x7F
                      00053 
                      00054 
                      00055 ;Constants
  00000003            00056 BITS_IN_PACKET                          equ             0x3     
  0000005A            00057 MAX_COUNTS                                      equ             0x5A
                      00058 
                      00059 
                      00060                                                                 org             0
0000   2???           00061                                                                 goto    Main
                      00062                                                                 org     4
0004   2???           00063                                                                 goto    ISR
                      00064                                                                 org             5
                      00065 
                      00066 ;
                      00067 ; Listing of LED Dimming Array
                      00068 ;
0005                  00069 DIM_LED_ARRAY:
0005   0782           00070     addwf PCL, f
0006   3400           00071     RETLW 0x00
0007   342F           00072     RETLW 0x2F
0008   344A           00073     RETLW 0x4A
0009   345D           00074     RETLW 0x5D
000A   346C           00075     RETLW 0x6C
000B   3479           00076     RETLW 0x79
000C   3483           00077     RETLW 0x83
000D   348C           00078     RETLW 0x8C
000E   3494           00079     RETLW 0x94
000F   349B           00080     RETLW 0x9B
0010   34A1           00081     RETLW 0xA1
0011   34A7           00082     RETLW 0xA7
0012   34AD           00083     RETLW 0xAD
0013   34B2           00084     RETLW 0xB2
0014   34B6           00085     RETLW 0xB6
0015   34BB           00086     RETLW 0xBB
0016   34BF           00087     RETLW 0xBF
0017   34C3           00088     RETLW 0xC3
0018   34C6           00089     RETLW 0xC6
0019   34CA           00090     RETLW 0xCA
001A   34CD           00091     RETLW 0xCD
001B   34D0           00092     RETLW 0xD0
001C   34D3           00093     RETLW 0xD3
001D   34D6           00094     RETLW 0xD6
001E   34D9           00095     RETLW 0xD9
001F   34DB           00096     RETLW 0xDB
0020   34DE           00097     RETLW 0xDE
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0021   34E0           00098     RETLW 0xE0
0022   34E3           00099     RETLW 0xE3
0023   34E5           00100     RETLW 0xE5
0024   34E7           00101     RETLW 0xE7
0025   34E9           00102     RETLW 0xE9
0026   34EB           00103     RETLW 0xEB
0027   34ED           00104     RETLW 0xED
0028   34EF           00105     RETLW 0xEF
0029   34F1           00106     RETLW 0xF1
002A   34F3           00107     RETLW 0xF3
002B   34F5           00108     RETLW 0xF5
002C   34F6           00109     RETLW 0xF6
002D   34F8           00110     RETLW 0xF8
002E   34FA           00111     RETLW 0xFA
002F   34FB           00112     RETLW 0xFB
0030   34FD           00113     RETLW 0xFD
0031   34FE           00114     RETLW 0xFE
0032   34FF           00115     RETLW 0xFF
                      00116 
                      00117 
0033                  00118 Main:
                      00119 
                      00120 ;Initialize ANSEL register
0033   1683 1703      00121         banksel ANSELA
0035   1005           00122         BCF ANSELA, ANSA0
0036   1085           00123         BCF ANSELA, ANSA1
0037   1105           00124         BCF ANSELA, ANSA2
0038   1205           00125         BCF ANSELA, ANSA4
0039   1285           00126         BCF ANSELA, ANSA5
                      00127 
                      00128 ; Initialize pins 
                      00129 ; RA1, RA2, RA4, and RA5 --> Outputs
                      00130 ; RA0 --> Input
003A   1283 1703      00131         banksel LATA
003C   1085           00132         bcf LATA, LATA1
003D   1105           00133         bcf LATA, LATA2
003E   1205           00134         bcf LATA, LATA4
003F   1285           00135         bcf LATA, LATA5
0040   1683 1303      00136         banksel TRISA
0042   1085           00137         BCF TRISA, TRISA1
0043   1105           00138         BCF TRISA, TRISA2
0044   1205           00139         BCF TRISA, TRISA4
0045   1285           00140         BCF TRISA, TRISA5
                      00141 
                      00142 
                      00143 ;Set up timer 0 with 2x prescaler (Bit value = 000)
0046   1683 1303      00144         banksel OPTION_REG
0048   1281           00145         BCF OPTION_REG, T0CS
0049   1181           00146         BCF OPTION_REG, PSA
004A   1001           00147         BCF OPTION_REG, PS0
004B   1081           00148         BCF OPTION_REG, PS1
004C   1101           00149         BCF OPTION_REG, PS2
                      00150 
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00151 ; Set up timer 1 for the stepper + LEDs
004D   1283 1303      00152     banksel T1CON
004F   1391           00153     BCF T1CON, TMR1CS1 ; Set the source to instruction clock
0050   1311           00154     BCF T1CON, TMR1CS0 
0051   1691           00155     BSF T1CON, T1CKPS1 ; Set the prescaler to 4. 
0052   1211           00156     BCF T1CON, T1CKPS0 ; For 8, change BCF to BSF
0053   1392           00157     BCF T1GCON, TMR1GE ; Disable the gate control
                      00158 
                      00159 ;########## PWM ##########
                      00160 ;   Set up timer 2 for the communication protocol
                      00161 ;    movlw       0xFA        ; Move 0xFA the working register 250 to reach 1ms
                      00162 ;    banksel     PR2     ; Select the bank with PR2
                      00163 ;    movwf       PR2     ; Move 0xFA to PR2 so that the timer counts through 250 (not including pre or p
                            ost scalers)
                      00164                     ; Leave the default T2CON register to have a 1:1 postscaler and 1:1 prescaler with t
                            he timer off
                      00165 
                      00166 ;       Setting up timer 2
0054   30FF           00167         movlw           0xFF                    ; Move 0xFF to the working register
0055   1283 1703      00168         banksel         PR2                             ; Select the bank with PR2
0057   0091           00169         movwf           PR2                             ; Move 0xFF to PR2 so that the timer counts thro
                            ugh 255 (not including pre or post scalers)
                      00170 ;       movlw           0x07                    ; Move 0x07 to the working register
0058   1283 1703      00171         banksel         T2CON                   ; Select the bank with the t2con register
                      00172 ;       movwf           T2CON                   ; Move 0x07 into the T2CON register to have a 1:1 postsc
                            aler and 1:16 prescaler
005A   1592           00173         BSF                     T2CON, 3
005B   1612           00174         BSF                     T2CON, 4
005C   1692           00175         BSF                     T2CON, 5
005D   1712           00176         BSF                     T2CON, 6
                      00177 ;       BSF                     T2CON, 1
                      00178 ;       banksel         PIR1
                      00179 ;       bcf                     PIR1, TMR2IF    ; 
                      00180 ;       banksel         PIE1                    ; Select the bank with the PIE1 register
                      00181 ;       bsf             PIE1, TMR2IE    ; Enable the timer 2 interrupt 
                      00182 
                      00183 ; Initialize the variables
005E   3003           00184         movlw           BITS_IN_PACKET
005F   00F3           00185         movwf           BITS_LEFT
0060   305A           00186         movlw           MAX_COUNTS
0061   00F4           00187         movwf           COUNTS_LEFT
0062   3000           00188         movlw           0x00
0063   00F9           00189         movwf           IS_PAIRED
0064   00FB           00190         movwf           LED_ON
                      00191 
                      00192 ;       Set up the interrupt on rising edge on RA0
0065   1283 1303      00193         banksel         INTCON          ; Select the bank with the intcon register
0067   158B           00194         bsf             INTCON, GPIE    ; Enable the interrupt on change interrupts
0068   1283 1303      00195         banksel         IOCAF
006A   1008           00196         bcf             IOCAF, IOCAF0
006B   1683 1303      00197         banksel         IOCAP           ; Select the bank with the IOCAP register
006D   1408           00198         bsf             IOCAP, IOCAP0   ; Enable the interrupt on positive edge
                      00199 
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00200 ; Enable External Interrupts
006E   1283 1303      00201         banksel INTCON
0070   170B           00202         bsf INTCON, PEIE
                      00203 
                      00204 ; Enable global interrupts
0071   1283 1303      00205         banksel INTCON
0073   178B           00206         bsf INTCON, GIE 
                      00207 
0074   2???           00208         goto $ ;Stay here after execution is done
                      00209 
                      00210         ;######         END OF MAIN             #######
                      00211 
                      00212 
                      00213 ;       Interrupt Response Routine
0075                  00214 ISR:
0075   00F5           00215 PUSH    movwf   WREG_TEMP       ; save WREG
0076   0803           00216                 movf    STATUS,W        ; store STATUS in WREG
0077   0183           00217                 clrf    STATUS          ; change file register to bank 0
0078   00F6           00218                 movwf   STATUS_TEMP     ; save STATUS value
0079   080A           00219                 movf    PCLATH,W        ; store PCLATH in WREG
007A   00F7           00220                 movwf   PCLATH_TEMP     ; save PCLATH value
007B   018A           00221                 clrf    PCLATH          ; change to program memory page 0
                      00222 
007C                  00223 ISR_BODY:
                      00224         ; Check source of interrupt
                      00225 
007C                  00226 TIMER2_CHECK:
007C   1283 1303      00227                 banksel         PIR1                    ; Select the bank with the PIR1 register
007E   188C           00228                 btfsc           PIR1, TMR2IF    ; Check to see if Timer 2 caused the interrupt, skip if 
                            not
007F   2???           00229                 GOTO            PWM     ; Go to PWM
                      00230 
0080   1283 1303      00231                 banksel IOCAF   ;Interrupt on rising edge
0082   1808           00232                 btfsc IOCAF, IOCAF0             ; If Interrupt was from Start bit (Edge)
0083   2???           00233                 call START_BIT; Call start bit response routine
                      00234 
                      00235 
0084   1283 1303      00236                 banksel INTCON
0086   1E8B           00237                 btfss   INTCON, TMR0IE  ;Skip the timer 0 check if its interrupt is disabled.
0087   2???           00238                 goto    TIMER1_CHECK
                      00239         
0088   190B           00240                 btfsc INTCON, TMR0IF            ; If Interrupt was from comms timer.
0089   2???           00241                 call RECEIVE; Call timer 0 response routine
                      00242 
008A                  00243 TIMER1_CHECK:   
008A   1283 1303      00244                 banksel         PIR1            ; Select the bank with the PIR1 register
008C   180C           00245                 btfsc           PIR1, TMR1IF    ; Check to see if Timer 1 caused the interrupt, skip if 
                            not
008D   2???           00246                 call            TIMER1_INTERRUPTSOURCE  ; Go to LED_TIMEOUT
                      00247                 
008E   2???           00248                 GOTO POP
                      00249 
                      00250 ;This is the waiting mode of the receive SM.
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

008F                  00251 START_BIT:
                      00252 
                      00253         ;Set up TMR0 for half the bit period.
008F   1683 1303      00254         banksel OPTION_REG
0091   1281           00255         BCF OPTION_REG, T0CS
0092   1181           00256         BCF OPTION_REG, PSA
0093   1001           00257         BCF OPTION_REG, PS0
0094   1081           00258         BCF OPTION_REG, PS1
0095   1101           00259         BCF OPTION_REG, PS2
0096   30D2           00260         movlw                   0xD2    ;Half bit period away from rollover
0097   1283 1303      00261         banksel                 TMR0
0099   0081           00262         movwf                   TMR0
                      00263         
009A   1283 1303      00264         banksel         IOCAF
                      00265         ; Clear and disable the RA0 rising edge interrupt
009C   1008           00266         bcf IOCAF, IOCAF0
009D   1683 1303      00267         banksel         IOCAP
009F   1008           00268         bcf IOCAP, IOCAP0
00A0   1283 1303      00269         banksel INTCON
00A2   100B           00270         bcf INTCON, RAIF ;Clear the RA change interrupt flag in INTCON
00A3   118B           00271         bcf INTCON, GPIE ;Disable the RA change int.
                      00272         
                      00273         ;Shift the variable 1 left and read the pin.
00A4   1283 1303      00274         banksel         PORTA
00A6   0DF0           00275         rlf                     PACKET
00A7   1070           00276         bcf                     PACKET, 0
00A8   1805           00277         btfsc           PORTA, LINE_IN
00A9   1470           00278         bsf                     PACKET, 0
                      00279         
                      00280         ;Unmask the timer 0 interrupt.
00AA   1283 1303      00281         banksel         INTCON
00AC   110B           00282         bcf                     INTCON,TMR0IF
00AD   168B           00283         bsf                     INTCON,TMR0IE 
                      00284 
                      00285         ;TEST pulse bit2 hi for one cycle
                      00286         ;banksel                LATA
                      00287         ;BSF                    LATA, LATA2
                      00288         ;bcf                    LATA, LATA2
                      00289         
00AE   0008           00290         RETURN
                      00291 
                      00292 ;This deals with filling up the xceive variable.
00AF                  00293 RECEIVE:
                      00294         
                      00295         ;Shift the variable 1 left and read the pin.
00AF   1283 1303      00296         banksel         PORTA
00B1   0DF0           00297         rlf                     PACKET
00B2   1070           00298         bcf                     PACKET, 0
00B3   1805           00299         btfsc           PORTA, LINE_IN
00B4   1470           00300         bsf                     PACKET, 0
                      00301         
                      00302         ;Set up TMR0 for the bit period.
00B5   1683 1303      00303         banksel OPTION_REG
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00B7   1281           00304         BCF OPTION_REG, T0CS
00B8   1181           00305         BCF OPTION_REG, PSA
00B9   1001           00306         BCF OPTION_REG, PS0
00BA   1081           00307         BCF OPTION_REG, PS1
00BB   1101           00308         BCF OPTION_REG, PS2
00BC   3099           00309         movlw                   0x99    ;Full bit period away from rollover.
00BD   1283 1303      00310         banksel                 TMR0
00BF   0081           00311         movwf                   TMR0
                      00312         
                      00313         ;Clear the timer 0 interrupt
00C0   1283 1303      00314         banksel         INTCON
00C2   110B           00315         bcf                     INTCON,TMR0IF
00C3   168B           00316         bsf                     INTCON,TMR0IE
                      00317 
                      00318 ;       ;TEST PULSE LATA2 for 2 cycles
                      00319         ;banksel LATA
                      00320         ;bsf            LATA, LATA2
                      00321         ;NOP
                      00322         ;bcf            LATA, LATA2
                      00323 
                      00324         ;Decrement bits left counter, skip if zero
00C4   0BF3           00325         DECFSZ          BITS_LEFT
00C5   0008           00326         RETURN
00C6   2???           00327         goto            LAST_BIT_READ
                      00328 
                      00329 ;This part of the code interprets the transmission and takes actions based on it.
00C7                  00330 LAST_BIT_READ:
                      00331 
                      00332 ;Disable timer 0 interrupt
00C7   1283 1303      00333         banksel         INTCON
00C9   128B           00334         bcf                     INTCON,TMR0IE
                      00335 
                      00336 ;Reset transmission counter.
00CA   3003           00337         MOVLW           BITS_IN_PACKET
00CB   00F3           00338         MOVWF           BITS_LEFT
                      00339 
                      00340 ; Reenable the rising edge interrupt
                      00341 ;       Set up the interrupt on rising edge on RA0
00CC   1283 1303      00342         banksel         INTCON          ; Select the bank with the intcon register
00CE   158B           00343         bsf             INTCON, GPIE    ; Enable the interrupt on change interrupts
00CF   1283 1303      00344         banksel         IOCAF
00D1   1008           00345         bcf             IOCAF, IOCAF0
00D2   1683 1303      00346         banksel         IOCAP           ; Select the bank with the IOCAP register
00D4   1408           00347         bsf             IOCAP, IOCAP0   ; Enable the interrupt on positive edge
                      00348         
                      00349         ;Check whether the status has changed.
00D5   0870           00350         movf    PACKET, W
00D6   00F8           00351         movwf   PACKET_COPY
00D7   0CF8           00352         RRF             PACKET_COPY
00D8   0878           00353         movf    PACKET_COPY, W
00D9   3901           00354         andlw   0x01
00DA   0279           00355         SUBWF   IS_PAIRED, W
00DB   1D70           00356         BTFSS PACKET, 2 ; See if input is noisy (ie a start bit of 0), ignore if it is
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00DC   0008           00357                 RETURN
00DD   1D03           00358         BTFSS   STATUS, Z ;If the things are the same, don't change anything
00DE   2???           00359         CALL    START_MOVING
                      00360 
                      00361         ;Set the LED color variable accordingly.
00DF   01FA           00362         CLRF    COLOR
00E0   0870           00363         movf    PACKET, W
00E1   3901           00364         ANDLW   0x01
00E2   1D03           00365         BTFSS   STATUS, Z
00E3   147A           00366         BSF             COLOR, 0
                      00367 
00E4   0008           00368         RETURN
                      00369         
00E5                  00370 START_MOVING:
                      00371                 ;First update the pairing status.
00E5   0879           00372                 movf            IS_PAIRED, W
00E6   3A01           00373                 xorlw           0x01
00E7   00F9           00374                 movwf           IS_PAIRED
                      00375 
                      00376                 ;Then determine which way to go.
00E8   1283 1703      00377                 banksel         LATA
00EA   1879           00378                 BTFSC           IS_PAIRED, 0
00EB   1605           00379                 BSF                     LATA, STEPPER_DIR       
00EC   1C79           00380                 BTFSS           IS_PAIRED, 0
00ED   1205           00381                 BCF                     LATA, STEPPER_DIR
                      00382                 
                      00383                 ;Change the motor status to moving.
00EE   1471           00384                 BSF                     MOTOR_STATE, 0
                      00385                 
                      00386                 ; Set up timer 1 with the required motor motion time
00EF   1283 1303      00387                 banksel         T1CON           ; Select the bank with the T1CON register
00F1   1011           00388                 bcf             T1CON, TMR1ON   ; Turn timer 1 off
00F2   1391           00389                 BCF T1CON, TMR1CS1 ; Set the source to instruction clock
00F3   1311           00390                 BCF T1CON, TMR1CS0 
00F4   1691           00391                 BSF T1CON, T1CKPS1 ; Set the prescaler to 4
00F5   1211           00392                 BCF T1CON, T1CKPS0 
00F6   1392           00393                 BCF T1GCON, TMR1GE ; Disable the gate control
                      00394 
                      00395 ;               ;Check if the motor was moving.
                      00396 ;               BTFSC           STEPPER_EN, 0
                      00397 ;               GOTO            MID_STEP                
                      00398 
                      00399 ;When not currently stepping, set the default timer value.
                      00400 ;NOT_MID_STEP:
00F7   1283 1303      00401                 banksel TMR1L ; First set the TMR1 value to 0
00F9   3000           00402                 MOVLW   0x00
00FA   008F           00403                 MOVWF   TMR1L
00FB   0090           00404                 MOVWF   TMR1H
                      00405 ;               GOTO    T1_ENABLE_INTERRUPT
                      00406 
                      00407 ;If direction is changed mid-step, the timer must be set shorter not to overrun the mechanism.
                      00408 ;Do a crappy two's complement. Not really tested for robustness.
                      00409 ;MID_STEP:
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00410 ;               banksel TMR1L
                      00411 ;               movlw   0xFF
                      00412 ;               subwf   TMR1H, F
                      00413 ;               subwf   TMR1L, F
                      00414                 
00FC                  00415 T1_ENABLE_INTERRUPT:
00FC   1683 1303      00416                 banksel PIE1 ; Prepare to start timer 1
00FE   140C           00417                 BSF PIE1, TMR1IE ; Set the timer 1 interrupt enable
00FF   1283 1303      00418                 banksel T1CON
0101   1411           00419                 BSF T1CON, TMR1ON ; Turn on timer 1
0102   1283 1303      00420                 banksel PIR1 ; Then clear the T1 interrupt flag
0104   100C           00421                 BCF PIR1, TMR1IF
                      00422                 
                      00423                 ;Activate the motor.
0105   1283 1703      00424                 banksel LATA
0107   1685           00425                 BSF LATA, STEPPER_EN
0108   0008           00426                 RETURN
                      00427 
0109                  00428 TIMER1_INTERRUPTSOURCE:
                      00429                 ;       Disable timer 1
                      00430                 ;banksel                T1CON           ; Select the bank with the T1CON register
                      00431                 ;bcf            T1CON, TMR1ON   ; Turn timer 1 off
0109   1283 1303      00432                 banksel         PIR1            ; Select the bank with the PIR1 register
010B   100C           00433                 bcf             PIR1, TMR1IF    ; Clear the Timer 1 interrupt flag
                      00434                 ;banksel                PIE1            ; Select the bank with the INTCON register
                      00435                 ;bcf            PIE1, TMR1IE    ; Disable the timer 1 interrupt
                      00436 
                      00437         ;banksel LATA
                      00438         ;bsf LATA, BLUE_LED
                      00439 
                      00440                 ;Determine timer 1 interrup source. Motor vs. LEDs
010C   1871           00441                 btfsc MOTOR_STATE, 0 ;If MOTOR_STATE is set (Info is on bit 0)
010D   2???           00442                 CALL STOP_MOVING ;Stop moving. Make sure it doesnt return back here
010E   2???           00443                 CALL DIM_LEDS ;Timer 1 interrupt was to turn off LEDs
010F   0008           00444                 RETURN
                      00445 
0110                  00446 STOP_MOVING:
0110   1283 1303      00447                 banksel         T1CON           ; Select the bank with the T1CON register
0112   1011           00448                 bcf             T1CON, TMR1ON   ; Turn timer 1 off
0113   1283 1703      00449                 banksel LATA
0115   1285           00450                 BCF LATA, STEPPER_EN ;Clear bit 0 in stepper enable
0116   1071           00451                 BCF MOTOR_STATE,0 ;Set motor state to not moving
0117   1D70           00452                 BTFSS PACKET, 2 ; See if start bit is set
0118   0008           00453                         RETURN
0119   1879           00454                 BTFSC   IS_PAIRED, 0 ; Only turn on LEDs if paired
011A   2???           00455                 CALL TURN_LEDS_ON
011B   1C79           00456                 BTFSS   IS_PAIRED, 0
011C   2???           00457                 CALL    TURN_LEDS_OFF
                      00458 
011D   0008           00459                 RETURN
                      00460 
                      00461 ;Turns on the appropriate color of the LEDs and changes TMR1 config.
011E                  00462 TURN_LEDS_ON:
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE 10


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00463                 ;TEST CODE. DISABLE THE INTERRUPTS FOR NOW
                      00464                 ;banksel                PIE1            ; Select the bank with the INTCON register
                      00465                 ;bcf            PIE1, TMR1IE    ; Disable the timer 1 interrupt
                      00466 
                      00467                 ; Set up timer 1 with the required LED update time
011E   1283 1303      00468                 banksel         T1CON           ; Select the bank with the T1CON register
0120   1011           00469                 bcf             T1CON, TMR1ON   ; Turn timer 1 off
0121   1391           00470                 BCF T1CON, TMR1CS1 ; Set the source to instruction clock
0122   1311           00471                 BCF T1CON, TMR1CS0 
0123   1291           00472                 BCF T1CON, T1CKPS1 ; Set the prescaler to 2
0124   1611           00473                 BSF T1CON, T1CKPS0 
0125   1392           00474                 BCF T1GCON, TMR1GE ; Disable the gate control
0126   1411           00475                 BSF     T1CON, TMR1ON   ;Reenable the timer
                      00476                 ;Set the counter to 45
0127   305A           00477                 MOVLW           MAX_COUNTS
0128   00F4           00478                 MOVWF           COUNTS_LEFT
                      00479 
                      00480                 ;Set up the LEDs
0129   300C           00481                 MOVLW           0x0C
012A   00FC           00482                 MOVWF           LED_Timeval
012B   00FD           00483                 MOVWF           LED_Counter
                      00484 
                      00485         ;               ;Transfer the color into the PWM color field
                      00486         ;               BCF                     PWM_COLOR, 0
                      00487         ;               BTFSC           COLOR, 0
                      00488         ;               BSF                     PWM_COLOR, 0
                      00489                 ;Turn on the LED PWM by setting the timer load to 255, clearing the interrupt, enabling 
                            it and turning the timer on.
012C   1283 1703      00490                 banksel TMR2
012E   30FF           00491                 MOVLW   0xFF
012F   0090           00492                 MOVWF   TMR2
0130   1283 1303      00493                 banksel PIR1
0132   108C           00494                 BCF             PIR1, TMR2IF
0133   1683 1303      00495                 banksel PIE1
0135   148C           00496                 BSF             PIE1, TMR2IE
0136   1283 1703      00497                 banksel T2CON
0138   1512           00498                 BSF             T2CON, TMR2ON
                      00499                 ;banksel LATA
                      00500                 ;BSF            LATA, LATA2
0139   0008           00501                 RETURN
                      00502 
                      00503 ;This dims the LEDs
013A                  00504 DIM_LEDS:
013A   2???           00505                 CALL LED_ON_MAX
013B   0BFD           00506                 DECFSZ LED_Counter
013C   2???           00507                 GOTO CONTINUE_LEDS
013D   2???           00508                 CALL RESET_TIME
                      00509 
013E                  00510 CONTINUE_LEDS:          
                      00511                                                                         ;decrement the counter
                      00512                 ;If the counter is 0, turn the LEDs off
013E   0BF4           00513                 DECFSZ          COUNTS_LEFT, F
013F   0008           00514                 RETURN
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE 11


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00515 
0140                  00516 TURN_LEDS_OFF:
                      00517                 ;Turn off the PWM
0140   1283 1703      00518                 banksel LATA
0142   1105           00519                 BCF             LATA, BLUE_LED
0143   1085           00520                 BCF             LATA, RED_LED
                      00521                 ;Turn off timer 1 and disable its interrupt
0144   100C           00522                 BCF PIE1, TMR1IE ; Clear the timer 1 interrupt enable
0145   1283 1303      00523                 banksel T1CON
0147   1011           00524                 BCF T1CON, TMR1ON ; Turn off timer 1
                      00525 
                      00526                 ;Turn off the PWM timer, disable its interrupt and clear its flag
0148   1283 1703      00527                 banksel T2CON
014A   1112           00528                 BCF             T2CON, TMR2ON
014B   1683 1303      00529                 banksel PIE1
014D   108C           00530                 BCF             PIE1, TMR2IE
014E   1283 1303      00531                 banksel PIR1
0150   108C           00532                 BCF             PIR1, TMR2IF
                      00533 
0151   0008           00534                 RETURN
                      00535 
0152                  00536 RESET_TIME:
0152   0BFC           00537                 decfsz LED_Timeval
0153   2???           00538                 GOTO CONTINUE_RESET
0154   0AFC           00539                 incf    LED_Timeval
0155   0AFC           00540                 incf    LED_Timeval
0156                  00541 CONTINUE_RESET:
0156   087C           00542                 movf LED_Timeval, W
0157   00FD           00543                 movwf LED_Counter
0158   2???           00544                 Call LED_ON_MIN
0159   0008           00545                 RETURN
                      00546 
015A                  00547 LED_ON_MAX:
015A   3001           00548                 movlw 0x01
015B   00FE           00549                 movwf LED_Lowerval
015C   30FF           00550                 movlw 0xFF
015D   00FF           00551                 movwf LED_Upperval
015E   0008           00552                 RETURN
                      00553 
015F                  00554 LED_ON_MIN:
015F   3001           00555                 movlw 0x01
0160   00FF           00556                 movwf LED_Upperval
0161   30FF           00557                 movlw 0xFF
0162   00FE           00558                 movwf LED_Lowerval
0163   0008           00559                 RETURN
                      00560                 
                      00561 
0164                  00562 PWM: 
                      00563                 ; Turn Timer2 OFF
0164   1283 1703      00564                 banksel T2CON
0166   1112           00565                 bcf T2CON, TMR2ON ; Turn Timer2 OFF
0167   1283 1303      00566                 banksel PIR1
0169   108C           00567                 BCF             PIR1, TMR2IF
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE 12


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

016A   187B           00568                 BTFSC   LED_ON, 0; Test the LED_On_Flag, skip if clear
016B   2???           00569                 GOTO    PWM_GO_LO; Go to LOW_TIME
016C   2???           00570                 GOTO    PWM_GO_HI; Go to HIGH_TIME
                      00571 
016D                  00572 PWM_GO_HI:      ; Go to the next look up table value
                      00573 
016D   087F           00574                 movf LED_Upperval, W
                      00575 
016E   1283 1703      00576                          banksel        PR2                             ; Select the bank with PR2
0170   0091           00577                          movwf          PR2                             ; Move 0xFF to PR2 so that the t
                            imer counts through 255 (not including pre or post scalers)
                      00578                 
0171   1283 1703      00579                         banksel LATA
0173   187A           00580                         btfsc COLOR,0                   ; Test the color flag, skip if set
0174   1505           00581                         BSF LATA, BLUE_LED                              ; Turn on blue LED
0175   1C7A           00582                         btfss COLOR,0                   ; Test the color flag, skip if clear
0176   1485           00583                         BSF LATA, RED_LED                               ; Turn on blue LED
0177   147B           00584                         BSF LED_ON,0                    ; Set the on flag
                      00585 
                      00586                         ; Turn Timer2 ON
0178   1283 1703      00587                         banksel T2CON
017A   1512           00588                         bsf T2CON, TMR2ON ; Turn Timer2 ON
                      00589 
017B   2???           00590                         GOTO POP
                      00591 
                      00592 
017C                  00593 PWM_GO_LO:      ; Go to the next look up table value
017C   087E           00594                         movf LED_Lowerval, W
                      00595 
017D   1283 1703      00596                          banksel        PR2                             ; Select the bank with PR2
017F   0091           00597                          movwf          PR2                             ; Move 0xFF to PR2 so that the t
                            imer counts through 255 (not including pre or post scalers)
                      00598 
0180   1283 1703      00599                         banksel LATA
0182   1105           00600                         BCF             LATA, BLUE_LED
0183   1085           00601                         BCF             LATA, RED_LED
0184   107B           00602                         BCF     LED_ON,0                ; Clear the on flag
                      00603                         ; Turn Timer2 ON
0185   1283 1703      00604                         banksel T2CON
0187   1512           00605                         bsf T2CON, TMR2ON ; Turn Timer2 ON
                      00606 
0188   2???           00607                 GOTO POP
                      00608                 
0189                  00609 POP: 
0189   0183           00610         clrf STATUS ;select bank 0
018A   0877           00611         movf PCLATH_TEMP,W ;store saved PCLATH value in WREG
018B   008A           00612         movwf PCLATH ;restore PCLATH
018C   0876           00613         movf STATUS_TEMP,W ;store saved STATUS value in WREG
018D   0083           00614         movwf STATUS ;restore STATUS
018E   0EF5           00615         swapf WREG_TEMP,F ;prepare WREG to be restored
018F   0E75           00616         swapf WREG_TEMP,W ;restore WREG keeping STATUS bits
0190   0009           00617         retfie ;return from interrupt
                      00618 
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE 13


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

3FE6                  00619         END
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE 14


SYMBOL TABLE
  LABEL                             VALUE 

ADCON0                            0000001E
ADCON1                            0000001F
ADCS0                             00000004
ADCS1                             00000005
ADCS2                             00000006
ADFM                              00000007
ADGO                              00000001
ADIE                              00000006
ADIF                              00000006
ADON                              00000000
ADRES                             0000001C
ADRESH                            0000001D
ADRESL                            0000001C
ANSA0                             00000000
ANSA1                             00000001
ANSA2                             00000002
ANSA4                             00000004
ANSA5                             00000005
ANSELA                            00000185
APFCON                            00000188
BITS_IN_PACKET                    00000003
BITS_LEFT                         00000073
BKF0                              00000000
BKF1                              00000001
BKF2                              00000002
BKF3                              00000003
BKR0                              00000004
BKR1                              00000005
BKR2                              00000006
BKR3                              00000007
BLUE_LED                          00000002
C                                 00000000
C1CON0                            0000009D
C1CON1                            0000009E
C1HYS                             00000001
C1IE                              00000004
C1IF                              00000004
C1INTN                            00000006
C1INTP                            00000007
C1NCH                             00000000
C1OE                              00000005
C1ON                              00000007
C1OUT                             00000006
C1PCH0                            00000004
C1PCH1                            00000005
C1POL                             00000004
C1SP                              00000002
C1SYNC                            00000000
C2CON0                            0000009B
C2CON1                            0000009C
C2HYS                             00000001
C2IE                              00000005
C2IF                              00000005
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE 15


SYMBOL TABLE
  LABEL                             VALUE 

C2INTN                            00000006
C2INTP                            00000007
C2NCH                             00000000
C2OE                              00000005
C2ON                              00000007
C2OUT                             00000006
C2PCH0                            00000004
C2PCH1                            00000005
C2POL                             00000004
C2SP                              00000002
C2SYNC                            00000000
CCP1CON                           00000015
CCP1IE                            00000000
CCP1IF                            00000000
CCPM0                             00000000
CCPM1                             00000001
CCPM2                             00000002
CCPM3                             00000003
CCPR1                             00000013
CCPR1H                            00000014
CCPR1L                            00000013
CHS0                              00000002
CHS1                              00000003
CHS2                              00000004
CHS3                              00000005
CM1CON0                           0000009D
CM1CON1                           0000009E
CM2CON0                           0000009B
CM2CON1                           0000009C
CMOUT                             0000009F
COLOR                             0000007A
CONTINUE_LEDS                     0000013E
CONTINUE_RESET                    00000156
COUNTS_LEFT                       00000074
CWG1IF                            00000000
CWGAOD0                           00000004
CWGAOD1                           00000005
CWGARSE                           00000006
CWGAS0E                           00000000
CWGAS1E                           00000001
CWGAS2E                           00000002
CWGAS3E                           00000003
CWGASD                            00000198
CWGASDE                           00000007
CWGBKR                            00000193
CWGCON0                           00000195
CWGCON1                           00000196
CWGCON2                           00000197
CWGCS0                            00000001
CWGCS1                            00000002
CWGDBR                            00000194
CWGEN                             00000007
CWGFBK0                           00000003
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE 16


SYMBOL TABLE
  LABEL                             VALUE 

CWGFBK1                           00000004
CWGFBK2                           00000005
CWGFDB                            00000006
CWGFS0                            00000003
CWGFS1                            00000004
CWGFS2                            00000005
CWGFSEL                           00000002
CWGIE                             00000000
CWGLD                             00000007
CWGO0SEL                          00000000
CWGO1SEL                          00000001
CWGOE0                            00000006
CWGOE1                            00000005
CWGPH                             00000192
CWGPOL0                           00000004
CWGPOL1                           00000003
CWGRBK0                           00000000
CWGRBK1                           00000001
CWGRBK2                           00000002
CWGRDB                            00000007
CWGRS0                            00000000
CWGRS1                            00000001
CWGRS2                            00000002
DACCON0                           00000091
DACCON1                           00000092
DACEN                             00000007
DACOE                             00000005
DACPSS0                           00000002
DACR0                             00000000
DACR1                             00000001
DACR2                             00000002
DACR3                             00000003
DACR4                             00000004
DACRNG                            00000006
DBF0                              00000000
DBF1                              00000001
DBF2                              00000002
DBF3                              00000003
DBR0                              00000004
DBR1                              00000005
DBR2                              00000006
DBR3                              00000007
DC                                00000001
DCB0                              00000004
DCB1                              00000005
DIM_LEDS                          0000013A
DIM_LED_ARRAY                     00000005
F                                 00000001
FSR                               00000004
FVRBUFEN                          00000005
FVRBUFSS                          00000004
FVRCON                            00000090
FVREN                             00000007
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE 17


SYMBOL TABLE
  LABEL                             VALUE 

FVRRDY                            00000006
GIE                               00000007
GO                                00000001
GO_DONE                           00000001
GO_NOT_DONE                       00000001
GPIE                              00000003
HLTCKPS0                          00000000
HLTCKPS1                          00000001
HLTCON0                           00000115
HLTCON1                           00000116
HLTERS0                           00000002
HLTERS1                           00000003
HLTERS2                           00000004
HLTFEREN                          00000001
HLTIE                             00000002
HLTIF                             00000002
HLTON                             00000002
HLTOUTPS0                         00000003
HLTOUTPS1                         00000004
HLTOUTPS2                         00000005
HLTOUTPS3                         00000006
HLTPR                             00000114
HLTREREN                          00000000
HLTTMR                            00000113
HTS                               00000002
INDF                              00000000
INTCON                            0000000B
INTE                              00000004
INTEDG                            00000006
INTF                              00000001
IOCAF                             00000008
IOCAF0                            00000000
IOCAF1                            00000001
IOCAF2                            00000002
IOCAF3                            00000003
IOCAF4                            00000004
IOCAF5                            00000005
IOCAN                             00000108
IOCAN0                            00000000
IOCAN1                            00000001
IOCAN3                            00000002
IOCAN4                            00000003
IOCAN5                            00000004
IOCAP                             00000088
IOCAP0                            00000000
IOCAP1                            00000001
IOCAP2                            00000002
IOCAP3                            00000003
IOCAP4                            00000004
IOCAP5                            00000005
IRCF0                             00000004
IRCF1                             00000005
IRP                               00000007
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE 18


SYMBOL TABLE
  LABEL                             VALUE 

ISR                               00000075
ISR_BODY                          0000007C
IS_PAIRED                         00000079
LAST_BIT_READ                     000000C7
LATA                              00000105
LATA0                             00000000
LATA1                             00000001
LATA2                             00000002
LATA4                             00000004
LATA5                             00000005
LED_Counter                       0000007D
LED_Lowerval                      0000007E
LED_ON                            0000007B
LED_ON_MAX                        0000015A
LED_ON_MIN                        0000015F
LED_STATE                         00000072
LED_Timeval                       0000007C
LED_Upperval                      0000007F
LINE_IN                           00000000
LTS                               00000001
MAX_COUNTS                        0000005A
MCOUT                             0000009F
MCOUT1                            00000000
MCOUT2                            00000001
MOTOR_STATE                       00000071
Main                              00000033
NOT_BOR                           00000000
NOT_DONE                          00000001
NOT_GPPU                          00000007
NOT_PD                            00000003
NOT_POR                           00000001
NOT_T1SYNC                        00000002
NOT_TO                            00000004
OFF                               00000000
ON                                00000001
OPTION_REG                        00000081
OSCCON                            0000008F
OSCTUNE                           00000189
PACKET                            00000070
PACKET_COPY                       00000078
PCL                               00000002
PCLATH                            0000000A
PCLATH_TEMP                       00000077
PCON                              0000010F
PEIE                              00000006
PH0                               00000000
PH1                               00000001
PH2                               00000002
PH3                               00000003
PIE1                              0000008C
PIE2                              0000008D
PIE3                              0000008E
PIR1                              0000000C
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE 19


SYMBOL TABLE
  LABEL                             VALUE 

PIR2                              0000000D
PIR3                              0000000E
PMADR                             0000018E
PMADRH                            0000018F
PMADRL                            0000018E
PMCON1                            0000018C
PMCON2                            0000018D
PMDAT                             00000190
PMDATH                            00000191
PMDATL                            00000190
POP                               00000189
PORTA                             00000005
PR2                               00000111
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
PUSH                              00000075
PWM                               00000164
PWM_GO_HI                         0000016D
PWM_GO_LO                         0000017C
RA0                               00000000
RA1                               00000001
RA2                               00000002
RA3                               00000003
RA4                               00000004
RA5                               00000005
RAIF                              00000000
RD                                00000000
RECEIVE                           000000AF
RECEIVING                         00000001
RED_LED                           00000001
RESET_TIME                        00000152
START_BIT                         0000008F
START_MOVING                      000000E5
STATUS                            00000003
STATUS_TEMP                       00000076
STEP                              00000001
STEPPER_DIR                       00000004
STEPPER_EN                        00000005
STOP_MOVING                       00000110
T0CS                              00000005
T0SE                              00000004
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000011
T1GCON                            00000012
T1GGO                             00000003
T1GGO_NOT_DONE                    00000003
T1GPOL                            00000006
T1GSEL                            00000004
T1GSPM                            00000004
T1GSS0                            00000000
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE 20


SYMBOL TABLE
  LABEL                             VALUE 

T1GSS1                            00000001
T1GTM                             00000005
T1GVAL                            00000002
T1OSCEN                           00000003
T1_ENABLE_INTERRUPT               000000FC
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000112
T2OUTPS0                          00000003
T2OUTPS1                          00000004
T2OUTPS2                          00000005
T2OUTPS3                          00000006
TIMER1_CHECK                      0000008A
TIMER1_INTERRUPTSOURCE            00000109
TIMER2_CHECK                      0000007C
TMR0                              00000001
TMR0IE                            00000005
TMR0IF                            00000002
TMR1CS0                           00000006
TMR1CS1                           00000007
TMR1GE                            00000007
TMR1GIE                           00000007
TMR1GIF                           00000007
TMR1H                             00000010
TMR1IE                            00000000
TMR1IF                            00000000
TMR1L                             0000000F
TMR1ON                            00000000
TMR2                              00000110
TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TRISA                             00000085
TRISA0                            00000000
TRISA1                            00000001
TRISA2                            00000002
TRISA3                            00000003
TRISA4                            00000004
TRISA5                            00000005
TUN0                              00000000
TUN1                              00000001
TUN2                              00000002
TUN3                              00000003
TUN4                              00000004
TURN_LEDS_OFF                     00000140
TURN_LEDS_ON                      0000011E
VCFG                              00000006
W                                 00000000
WAITING                           00000000
WPUA                              0000010C
WPUA0                             00000000
WPUA1                             00000001
WPUA2                             00000002
MPASM  5.39                    DMC CONNOR.ASM   5-22-2016  19:30:24         PAGE 21


SYMBOL TABLE
  LABEL                             VALUE 

WPUA3                             00000003
WPUA5                             00000005
WR                                00000001
WREG_TEMP                         00000075
WREN                              00000002
WUA4                              00000004
Z                                 00000002
_.org_2_0074                      00000074
_BOREN_DIS                        00003CFF
_BOREN_EN                         00003FFF
_BOREN_SLEEP_DIS                  00003EFF
_CKLOUTEN_OFF                     00003FFF
_CKLOUTEN_ON                      00002FFF
_CONFIG                           00002007
_CP_OFF                           00003FFF
_CP_ON                            00003FBF
_DEVID1                           00002006
_FOSC_EC                          00003FFF
_FOSC_INT                         00003FFE
_IDLOC0                           00002000
_IDLOC1                           00002001
_IDLOC2                           00002002
_IDLOC3                           00002003
_MCLRE_OFF                        00003FDF
_MCLRE_ON                         00003FFF
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FEF
_WDT_OFF                          00003FF7
_WDT_ON                           00003FFF
_WRT_ALL                          000033FF
_WRT_FOURTH                       00003BFF
_WRT_HALF                         000037FF
_WRT_OFF                          00003FFF
__12F752                          00000001
__DEBUG                           1

Errors   :     0
Warnings :     0 reported,     0 suppressed
Messages :     0 reported,    66 suppressed

